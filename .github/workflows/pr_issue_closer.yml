name: Auto Close Linked Issue on PR Merge

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  close_linked_issue:
    # Only run if the PR was merged (not just closed without merging)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    # Needs permissions to read the branch name and write to issues
    permissions:
      pull-requests: read
      issues: write
      contents: read

    steps:
      - name: Close linked issue
        uses: actions/github-script@v7
        with:
          script: |
            const prHeadRef = context.payload.pull_request.head.ref;
            const issueTitle = context.payload.pull_request.title;
            let issueNumber = null;
            
            console.log(`PR Head Branch: ${prHeadRef}`);
            
            // 1. Attempt to extract issue number from the branch name (e.g., 'issue-1-setup')
            const branchMatch = prHeadRef.match(/^issue-([1-6])-\w+/i);
            
            if (branchMatch) {
              issueNumber = branchMatch[1];
              console.log(`Found issue number #${issueNumber} in branch name.`);
            } else {
              // Fallback: Check the PR title if the branch name fails (e.g., 'Issue 2: Completed task')
              const titleMatch = issueTitle.match(/(?:Issue)\s*#?(\d+)/i);
              if (titleMatch) {
                issueNumber = titleMatch[1];
                console.log(`Found issue number #${issueNumber} in PR title.`);
              }
            }
            
            if (issueNumber) {
              // Proceed with closing the detected issue
              console.log(`Attempting to close issue #${issueNumber}`);
              
              await github.rest.issues.update({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed'
              });
              
              console.log(`Successfully closed issue #${issueNumber}. The sequencer is triggered.`);
            } else {
              console.log('Could not reliably link PR to an open Quest Issue. Manual closure is required.');
            }