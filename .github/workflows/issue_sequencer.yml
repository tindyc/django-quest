name: Django Quest Issue Sequencer

on:
  issues:
    types: [closed]

jobs:
  open_next_issue:
    runs-on: ubuntu-latest

    # Permissions: can read repo and create issues
    permissions:
      contents: read
      issues: write

    outputs:
      finish_quest: ${{ steps.next.outputs.finish_quest }}

    steps:
      - name: Show closed issue info
        run: |
          echo "Closed issue: #${{ github.event.issue.number }}"
          echo "Title: ${{ github.event.issue.title }}"

      - name: Determine next issue by TITLE
        id: next
        shell: bash
        run: |
          TITLE="${{ github.event.issue.title }}"

          NEXT_TITLE=""
          NEXT_FILE=""
          NEXT_LABEL=""
          FINISH_QUEST="false"

          # Logic relies on Issue Title starting with "Issue X"
          if [[ "$TITLE" == "Issue 1"* ]]; then
            NEXT_TITLE="Issue 2 â€“ Project Core: Create Project Structure"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-2-project-core.md"
            NEXT_LABEL="issue-2"
          elif [[ "$TITLE" == "Issue 2"* ]]; then
            NEXT_TITLE="Issue 3 â€“ App Creation & Registration"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-3-app-and-registration.md"
            NEXT_LABEL="issue-3"
          elif [[ "$TITLE" == "Issue 3"* ]]; then
            NEXT_TITLE="Issue 4 â€“ URL Routing & View Test"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-4-url-and-view.md"
            NEXT_LABEL="issue-4"
          elif [[ "$TITLE" == "Issue 4"* ]]; then
            NEXT_TITLE="Issue 5 â€“ Models & Migrations"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-5-models-and-templates.md"
            NEXT_LABEL="issue-5"
          elif [[ "$TITLE" == "Issue 5"* ]]; then
            NEXT_TITLE="Issue 6 â€“ Superuser & Admin"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-6-superuser.md"
            NEXT_LABEL="issue-6"
          elif [[ "$TITLE" == "Issue 6"* ]]; then
            FINISH_QUEST="true"
          fi

          echo "next_title=$NEXT_TITLE" >> "$GITHUB_OUTPUT"
          echo "next_file=$NEXT_FILE" >> "$GITHUB_OUTPUT"
          echo "next_label=$NEXT_LABEL" >> "$GITHUB_OUTPUT"
          echo "finish_quest=$FINISH_QUEST" >> "$GITHUB_OUTPUT"

      - name: Stop if no action is needed
        if: steps.next.outputs.next_title == '' && steps.next.outputs.finish_quest == 'false'
        run: echo "âœ… No next issue to create."

      - name: Checkout repository for Issue Creation
        if: steps.next.outputs.next_title != ''
        uses: actions/checkout@v4

      - name: Create next issue
        if: steps.next.outputs.next_title != ''
        uses: peter-evans/create-issue-from-file@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: ${{ steps.next.outputs.next_title }}
          content-filepath: ${{ steps.next.outputs.next_file }}
          labels: ${{ steps.next.outputs.next_label }}

  finish_quest:
    runs-on: ubuntu-latest
    needs: open_next_issue
    if: needs.open_next_issue.outputs.finish_quest == 'true'

    permissions:
      contents: write

    steps:
      - name: Checkout repository for README update
        uses: actions/checkout@v4

      - name: Add Congratulations Message to README.md
        shell: bash
        run: |
          CONGRATS_MESSAGE=$(cat <<-'EOF'
          <div align="center">

          # ðŸŽ‰ Django Quest Complete!

          [![Quest Status: Completed](https://img.shields.io/badge/Quest%20Status-Completed-4caf50?style=for-the-badge&logo=django&logoColor=white)](#-quest-complete-congratulations-)

          **Youâ€™ve successfully completed the entire Django Quest Workshop.**  
          Your project is now a solid foundation to build your full Django application.

          </div>

          ---

          ### âœ… What youâ€™ve achieved

          - Set up a Python virtual environment and installed Django  
          - Created and configured your Django project  
          - Built your first Django app and wired up URLs & views  
          - Defined models and ran migrations  
          - Created a superuser and explored the Django admin  

          ---

          ### ðŸš€ Next steps

          1. **Run the project locally**

             ```bash
             python manage.py runserver
             ```

          2. **Log into the admin**

             - Visit: `http://127.0.0.1:8000/admin/`
             - Log in with your superuser credentials

          3. **Keep building**

             - Add more models, views, and templates  
             - Customize the admin  
             - Start shaping this into your real application âœ¨

          ---

          <details>
          <summary><strong>ðŸ’¡ Not sure what to build next?</strong></summary>

          - A personal blog or portfolio  
          - A simple task manager / to-do app  
          - A small catalog (books, games, recipes, anything!)  
          - A learning journal to track what you build next  

          </details>
          EOF
          )

          # Prepend congratulations to the TOP of README.md
          { printf "%s\n\n" "$CONGRATS_MESSAGE"; cat README.md; } > README.tmp && mv README.tmp README.md

      - name: Record completion in QUEST_COMPLETION_LOG.md
        shell: bash
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          {
            echo "## Django Setup Quest Completion"
            echo ""
            echo "MARKER: DJANGO_SETUP_QUEST_COMPLETION_TC"
            echo ""
            echo "- **Quest ID:** django-setup-quest-tc"
            echo "- **User:** @${{ github.actor }}"
            echo "- **Repository:** https://github.com/${{ github.repository }}"
            echo "- **Workflow Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "- **Completed at (UTC):** ${TIMESTAMP}"
            echo ""
            echo "---"
            echo ""
          } >> QUEST_COMPLETION_LOG.md

      - name: Commit and Push README changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'docs: Celebrate completion of Django Quest workshop!'
          branch: main
