name: Django Quest Issue Sequencer

on:
  issues:
    types: [closed]

jobs:
  open_next_issue:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write

    outputs:
      finish_quest: ${{ steps.next.outputs.finish_quest }}

    steps:
      - name: Show closed issue info
        run: |
          echo "Closed issue: #${{ github.event.issue.number }}"
          echo "Title: >>>${{ github.event.issue.title }}<<<"

      - name: Determine next issue based on TITLE (Unicode-safe)
        id: next
        shell: bash
        env:
          TITLE: ${{ github.event.issue.title }}
        run: |
          echo "DEBUG RAW TITLE:"
          printf '%q\n' "$TITLE"

          NEXT_TITLE=""
          NEXT_FILE=""
          NEXT_LABEL=""
          FINISH_QUEST="false"

          # Match "Issue X" robustly, regardless of spaces/dashes/punctuation
          if [[ "$TITLE" =~ ^Issue[[:space:]]*1([^0-9]|$) ]]; then
            NEXT_TITLE="Issue 2 â€“ Project Core: Create Project Structure"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-2-project-core.md"
            NEXT_LABEL="issue-2"

          elif [[ "$TITLE" =~ ^Issue[[:space:]]*2([^0-9]|$) ]]; then
            NEXT_TITLE="Issue 3 â€“ App Creation & Registration"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-3-app-and-registration.md"
            NEXT_LABEL="issue-3"

          elif [[ "$TITLE" =~ ^Issue[[:space:]]*3([^0-9]|$) ]]; then
            NEXT_TITLE="Issue 4 â€“ URL Routing & View Test"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-4-url-and-view.md"
            NEXT_LABEL="issue-4"

          elif [[ "$TITLE" =~ ^Issue[[:space:]]*4([^0-9]|$) ]]; then
            NEXT_TITLE="Issue 5 â€“ Models & Migrations"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-5-models-and-templates.md"
            NEXT_LABEL="issue-5"

          elif [[ "$TITLE" =~ ^Issue[[:space:]]*5([^0-9]|$) ]]; then
            NEXT_TITLE="Issue 6 â€“ Superuser & Admin"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-6-superuser.md"
            NEXT_LABEL="issue-6"

          elif [[ "$TITLE" =~ ^Issue[[:space:]]*6([^0-9]|$) ]]; then
            NEXT_TITLE="Issue 7 â€“ Show Your Data on the Page"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-7-show-data.md"
            NEXT_LABEL="issue-7"

          elif [[ "$TITLE" =~ ^Issue[[:space:]]*7([^0-9]|$) ]]; then
            NEXT_TITLE="Issue 8 â€“ Add a Blog Post Detail Page"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-8-blog-detail.md"
            NEXT_LABEL="issue-8"

          elif [[ "$TITLE" =~ ^Issue[[:space:]]*8([^0-9]|$) ]]; then
            NEXT_TITLE="Issue 9 â€“ Template Inheritance & Base Layout"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-9-template-inheritance.md"
            NEXT_LABEL="issue-9"

          elif [[ "$TITLE" =~ ^Issue[[:space:]]*9([^0-9]|$) ]]; then
            NEXT_TITLE="Issue 10 â€“ Quest Complete & Reflection"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-10-quest-complete.md"
            NEXT_LABEL="issue-10"

          elif [[ "$TITLE" =~ ^Issue[[:space:]]*10([^0-9]|$) ]]; then
            FINISH_QUEST="true"
          fi

          echo "next_title=$NEXT_TITLE" >> "$GITHUB_OUTPUT"
          echo "next_file=$NEXT_FILE" >> "$GITHUB_OUTPUT"
          echo "next_label=$NEXT_LABEL" >> "$GITHUB_OUTPUT"
          echo "finish_quest=$FINISH_QUEST" >> "$GITHUB_OUTPUT"

      - name: Stop if nothing to create
        if: steps.next.outputs.next_title == '' && steps.next.outputs.finish_quest == 'false'
        run: echo "No next issue to create."

      - name: Checkout repo
        if: steps.next.outputs.next_title != ''
        uses: actions/checkout@v4

      - name: Create next issue
        if: steps.next.outputs.next_title != ''
        uses: peter-evans/create-issue-from-file@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: ${{ steps.next.outputs.next_title }}
          content-filepath: ${{ steps.next.outputs.next_file }}
          labels: ${{ steps.next.outputs.next_label }}

  finish_quest:
    runs-on: ubuntu-latest
    needs: open_next_issue
    if: needs.open_next_issue.outputs.finish_quest == 'true'

    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Add congratulations to README
        run: |
          cat << 'EOF' > /tmp/CONGRATS_BLOCK.md
          <div align="center">

          # ðŸŽ‰ Django Quest Complete!

          [![Quest Status: Completed](https://img.shields.io/badge/Quest%20Status-Completed-4caf50?style=for-the-badge&logo=django&logoColor=white)]()

          **Youâ€™ve successfully completed the entire Django Quest Workshop.**

          </div>

          ---

          EOF
          cat /tmp/CONGRATS_BLOCK.md README.md > README.tmp
          mv README.tmp README.md

      - name: Record completion
        run: |
          {
            echo "## Django Setup Quest Completion"
            echo "- Completed by @${{ github.actor }} on $(date -u)"
            echo "---"
          } >> QUEST_COMPLETION_LOG.md

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: Celebrate Django Quest completion"
          branch: main
