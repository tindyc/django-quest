name: Collect Django Quest Completions

on:
  workflow_dispatch:          # Run manually from Actions tab
  schedule:
    - cron: "0 6 * * 1"       # every Monday at 06:00 UTC

jobs:
  collect_completions:
    # Only run in the original/template repo, not in student copies
    if: github.repository == 'tindyc/django-quest'

    runs-on: ubuntu-latest

    permissions:
      contents: write         # push to stats branch

    env:
      TEMPLATE_OWNER: tindyc
      TEMPLATE_REPO: django-quest

    steps:
      - name: Checkout repository (main branch)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0      # Ensure we can create/switch branches

      - name: Switch to or create stats branch
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ”€ Preparing stats branch..."

          # Check if remote stats branch exists
          if git ls-remote --exit-code --heads origin stats >/dev/null 2>&1; then
            echo "âœ… Remote stats branch exists. Checking it out..."
            git checkout stats
            git pull origin stats
          else
            echo "â„¹ï¸ stats branch does not exist yet. Creating from main..."
            git checkout -b stats
          fi

      - name: Collect completions and generate dashboard
        env:
          TEMPLATE_OWNER: ${{ env.TEMPLATE_OWNER }}
          TEMPLATE_REPO: ${{ env.TEMPLATE_REPO }}
        shell: bash
        run: |
          set -euo pipefail

          DASHBOARD_FILE="COMPLETED_QUESTS_DASHBOARD.md"

          TS=$(date -u +"%Y-%m-%d %H:%M UTC")
          TMP_LOG="$(mktemp)"
          TMP_MONTHS="$(mktemp)"
          TMP_USERS="$(mktemp)"
          TMP_PROJECTS="$(mktemp)"
          DETAILS_TABLE="$(mktemp)"

          TOTAL=0
          EARLIEST=""
          LATEST=""

          echo "ðŸ”Ž Searching for QUEST_COMPLETION_LOG.md files with Django Quest marker..."

          PAGE=1
          ALL_REPOS=""

          # We search public repos owned by TEMPLATE_OWNER that have
          # QUEST_COMPLETION_LOG.md containing the unique marker.
          # No Authorization header â†’ global public search works, no PAT needed.
          while :; do
            SEARCH_URL="https://api.github.com/search/code?q=filename:QUEST_COMPLETION_LOG.md+DJANGO_SETUP_QUEST_COMPLETION_TC+user:${TEMPLATE_OWNER}&per_page=100&page=${PAGE}"

            echo "  ðŸ”Ž Page ${PAGE} â€“ ${SEARCH_URL}"
            RESP=$(
              curl -sS \
                -H "Accept: application/vnd.github+json" \
                "${SEARCH_URL}"
            )

            # If GitHub returns an error object, show it and stop.
            if echo "$RESP" | jq -e 'type == "object" and has("message")' >/dev/null 2>&1; then
              echo "  âš ï¸ GitHub API error: $(echo "$RESP" | jq -r '.message')"
              break
            fi

            TOTAL_COUNT=$(echo "$RESP" | jq -r '.total_count // 0')
            PAGE_REPOS=$(echo "$RESP" | jq -r '.items[].repository.full_name // empty' 2>/dev/null || true)

            if [ -z "$PAGE_REPOS" ]; then
              # No items on this page â†’ stop
              break
            fi

            ALL_REPOS="${ALL_REPOS}"$'\n'"${PAGE_REPOS}"

            # Stop if we've fetched all results
            if [ $((PAGE * 100)) -ge "$TOTAL_COUNT" ]; then
              break
            fi

            PAGE=$((PAGE + 1))
          done

          # Normalise and dedupe repo list
          REPOS=$(echo "$ALL_REPOS" | sed '/^\s*$/d' | sort -u || true)

          if [ -z "$REPOS" ]; then
            echo "âš ï¸ No completed repositories found via search."
            {
              echo "# ðŸ“Š Django Setup Quest â€“ Completion Dashboard"
              echo
              echo "_Auto-generated from code search on ${TS}._"
              echo
              echo "## Summary"
              echo
              echo "- **Template repository:** \`${TEMPLATE_OWNER}/${TEMPLATE_REPO}\`"
              echo "- **Total completed repositories (with logs):** 0"
              echo
              echo "## Completions by Month (UTC)"
              echo
              echo "_No completion logs found yet._"
              echo
              echo "## Completed Repositories"
              echo
              echo "| # | Repository | GitHub User | Project Name | Repo Created (UTC) | Quest Completed (UTC) |"
              echo "|---|------------|-------------|--------------|---------------------|------------------------|"
            } > "${DASHBOARD_FILE}"
            exit 0
          fi

          echo "âœ… Found repositories with completion logs:"
          echo "${REPOS}"

          # --- Initialise detail table header ---
          {
            echo "| # | Repository | GitHub User | Project Name | Repo Created (UTC) | Quest Completed (UTC) |"
            echo "|---|------------|-------------|--------------|---------------------|------------------------|"
          } > "${DETAILS_TABLE}"

          INDEX=1

          # --- Process each repo and extract completion info ---
          while read -r repo; do
            [ -z "$repo" ] && continue

            echo "ðŸ“‚ Processing ${repo} ..."

            CONTENT_JSON=$(
              curl -sS \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${repo}/contents/QUEST_COMPLETION_LOG.md"
            )

            CONTENT_B64=$(echo "$CONTENT_JSON" | jq -r '.content // empty')

            if [ -z "$CONTENT_B64" ] || [ "$CONTENT_B64" = "null" ]; then
              echo "  â†’ â„¹ï¸ No QUEST_COMPLETION_LOG.md found via contents API. Skipping."
              continue
            fi

            # Decode to temp file (GitHub base64 may be line-wrapped)
            if ! echo "$CONTENT_B64" | base64 -d > "$TMP_LOG" 2>/dev/null; then
              echo "  â†’ âš ï¸ Failed to decode QUEST_COMPLETION_LOG.md. Skipping."
              continue
            fi

            # Ensure it actually looks like a Django Quest completion log
            if ! grep -q "DJANGO_SETUP_QUEST_COMPLETION_TC" "$TMP_LOG"; then
              echo "  â†’ âš ï¸ Marker not found in log. Skipping."
              continue
            fi

            # Lines may be Markdown bullets, e.g. "- **User:** @tindyc"
            LAST_USER_LINE=$(grep -i "User:" "$TMP_LOG" | tail -n 1 || true)
            LAST_TIME_LINE=$(grep -i "Completed at (UTC):" "$TMP_LOG" | tail -n 1 || true)

            if [ -z "$LAST_USER_LINE" ] || [ -z "$LAST_TIME_LINE" ]; then
              echo "  â†’ âš ï¸ Could not find 'User:' or 'Completed at (UTC):' lines. Skipping."
              continue
            fi

            # Strip Markdown and label prefix to isolate values
            USERNAME=$(
              echo "$LAST_USER_LINE" \
              | sed 's/\r$//' \
              | sed -E 's/^\s*-\s*\*\*?User:\**\s*@?//I' \
              | sed 's/\*\*//g' \
              | sed 's/[[:space:]]*$//'
            )

            COMPLETED_AT=$(
              echo "$LAST_TIME_LINE" \
              | sed 's/\r$//' \
              | sed -E 's/^\s*-\s*\*\*?Completed at \(UTC\):\**\s*//I' \
              | sed 's/\*\*//g' \
              | sed 's/[[:space:]]*$//'
            )

            [ -z "$USERNAME" ] && USERNAME="unknown"
            [ -z "$COMPLETED_AT" ] && COMPLETED_AT="unknown"

            REPO_NAME=$(basename "$repo")

            REPO_CREATED_AT=$(
              curl -sS \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${repo}" \
              | jq -r '.created_at // empty'
            )
            [ -z "$REPO_CREATED_AT" ] && REPO_CREATED_AT="unknown"

            # --- Update summary stats ---
            if [[ "$COMPLETED_AT" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}T ]]; then
              MONTH_KEY=${COMPLETED_AT:0:7}
              echo "$MONTH_KEY" >> "$TMP_MONTHS"

              if [ -z "$EARLIEST" ] || [[ "$COMPLETED_AT" < "$EARLIEST" ]]; then
                EARLIEST="$COMPLETED_AT"
              fi
              if [ -z "$LATEST" ] || [[ "$COMPLETED_AT" > "$LATEST" ]]; then
                LATEST="$COMPLETED_AT"
              fi
            fi

            echo "$USERNAME"  >> "$TMP_USERS"
            echo "$REPO_NAME" >> "$TMP_PROJECTS"

            # --- Append row to details table ---
            {
              echo "| ${INDEX} | [${repo}](https://github.com/${repo}) | [@${USERNAME}](https://github.com/${USERNAME}) | ${REPO_NAME} | ${REPO_CREATED_AT} | ${COMPLETED_AT} |"
            } >> "${DETAILS_TABLE}"

            INDEX=$((INDEX+1))
            TOTAL=$((TOTAL+1))

            echo "  â†’ âœ… Logged completion for @${USERNAME}"
          done <<< "${REPOS}"

          UNIQUE_USERS=0
          if [ -s "$TMP_USERS" ]; then
            UNIQUE_USERS=$(sort "$TMP_USERS" | uniq | wc -l | tr -d ' ')
          fi

          # --- Start writing dashboard file ---
          {
            echo "# ðŸ“Š Django Setup Quest â€“ Completion Dashboard"
            echo
            echo "_Auto-generated from code search on ${TS}._"
            echo
            echo "## ðŸ§¾ Summary"
            echo
            echo "- **Template repository:** \`${TEMPLATE_OWNER}/${TEMPLATE_REPO}\`"
            echo "- **Total completed repositories (with logs):** ${TOTAL}"
            echo "- **Unique learners (GitHub users):** ${UNIQUE_USERS}"
            if [ -n "$EARLIEST" ]; then
              echo "- **First recorded completion:** ${EARLIEST}"
            fi
            if [ -n "$LATEST" ]; then
              echo "- **Most recent completion:** ${LATEST}"
            fi
            echo
          } > "${DASHBOARD_FILE}"

          # --- Completions by Month ---
          {
            echo "## ðŸ“… Completions by Month (UTC)"
            echo
          } >> "${DASHBOARD_FILE}"

          if [ -s "$TMP_MONTHS" ]; then
            {
              echo "| Month (UTC) | Completions |"
              echo "|-------------|-------------|"
              sort "$TMP_MONTHS" | uniq -c | while read -r count month; do
                echo "| ${month} | ${count} |"
              done
              echo
            } >> "${DASHBOARD_FILE}"
          else
            {
              echo "_No completion timestamps available yet._"
              echo
            } >> "${DASHBOARD_FILE}"
          fi

          # --- Top learners (by completions) ---
          {
            echo "## ðŸ§‘â€ðŸŽ“ Top Learners (by recorded completions)"
            echo
          } >> "${DASHBOARD_FILE}"

          if [ -s "$TMP_USERS" ]; then
            {
              echo "| Rank | GitHub User | Completions |"
              echo "|------|------------|-------------|"
              sort "$TMP_USERS" | uniq -c | sort -rn | head -10 | nl -w2 -s' | ' | while read -r rank rest; do
                count=$(echo "$rest" | awk '{print $1}')
                user=$(echo "$rest" | awk '{print $2}')
                echo "| ${rank} | [@${user}](https://github.com/${user}) | ${count} |"
              done
              echo
            } >> "${DASHBOARD_FILE}"
          else
            {
              echo "_No learner data yet._"
              echo
            } >> "${DASHBOARD_FILE}"
          fi

          # --- Most common project names (repo names) ---
          {
            echo "## ðŸ— Popular Project Names"
            echo
          } >> "${DASHBOARD_FILE}"

          if [ -s "$TMP_PROJECTS" ]; then
            {
              echo "| Rank | Project Name | Completions |"
              echo "|------|-------------|-------------|"
              sort "$TMP_PROJECTS" | uniq -c | sort -rn | head -10 | nl -w2 -s' | ' | while read -r rank rest; do
                count=$(echo "$rest" | awk '{print $1}')
                name=$(echo "$rest" | awk '{print $2}')
                echo "| ${rank} | ${name} | ${count} |"
              done
              echo
            } >> "${DASHBOARD_FILE}"
          else
            {
              echo "_No project data yet._"
              echo
            } >> "${DASHBOARD_FILE}"
          fi

          # --- Detailed table of all completed repos ---
          {
            echo "## ðŸ“˜ Completed Repositories"
            echo
          } >> "${DASHBOARD_FILE}"

          cat "${DETAILS_TABLE}" >> "${DASHBOARD_FILE}"

          rm -f "$TMP_LOG" "$TMP_MONTHS" "$TMP_USERS" "$TMP_PROJECTS" "$DETAILS_TABLE"

          echo "âœ… Wrote completion dashboard to ${DASHBOARD_FILE}"

      - name: Commit dashboard to stats branch
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update Django Quest completion dashboard"
          branch: stats
