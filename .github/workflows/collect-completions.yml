name: Collect Django Quest Completions

on:
  workflow_dispatch:          # Run manually from Actions tab
  schedule:
    - cron: "0 6 * * 1"       # every Monday at 06:00 UTC

jobs:
  collect_completions:
    # Only run in the original/template repo, not in student copies
    if: github.repository == 'tindyc/django-quest'

    runs-on: ubuntu-latest

    permissions:
      contents: write         # push to stats branch

    steps:
      - name: Checkout repository (main branch)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0      # Ensure we can create/switch branches

      - name: Switch to or create stats branch
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ”€ Preparing stats branch..."

          # Check if remote stats branch exists
          if git ls-remote --exit-code --heads origin stats >/dev/null 2>&1; then
            echo "âœ… Remote stats branch exists. Checking it out..."
            git checkout stats
            git pull origin stats
          else
            echo "â„¹ï¸ stats branch does not exist yet. Creating from main..."
            git checkout -b stats
          fi

      - name: Collect completed quest repositories and generate dashboard
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ” Searching GitHub for QUEST_COMPLETION_LOG.md with unique TC marker..."

          # Search public code for:
          # - filename: QUEST_COMPLETION_LOG.md
          # - containing DJANGO_SETUP_QUEST_COMPLETION_TC
          SEARCH_URL="https://api.github.com/search/code?q=filename:QUEST_COMPLETION_LOG.md+DJANGO_SETUP_QUEST_COMPLETION_TC&per_page=100"

          # Use curl + jq instead of gh api to avoid path/404 issues
          REPOS=$(
            curl -sS \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "${SEARCH_URL}" \
            | jq -r '.items[].repository.full_name // empty' \
            | sort -u
          )

          DASHBOARD_FILE="COMPLETED_QUESTS_DASHBOARD.md"

          TOTAL=0
          EARLIEST=""
          LATEST=""

          TMP_LOG="$(mktemp)"
          TMP_MONTHS="$(mktemp)"

          TS=$(date -u +"%Y-%m-%d %H:%M UTC")

          # Start writing the dashboard
          {
            echo "# ðŸ“Š Django Setup Quest â€“ Completion Dashboard"
            echo
            echo "_Auto-generated from GitHub search on ${TS}._"
            echo
          } > "${DASHBOARD_FILE}"

          if [ -z "${REPOS}" ]; then
            echo "â„¹ï¸ No completed quests found."
            {
              echo "## Summary"
              echo
              echo "- **Total completed repositories:** 0"
              echo "- No completions found yet."
              echo
              echo "## Completions by Month (UTC)"
              echo
              echo "_No valid completion timestamps to summarise by month._"
              echo
              echo "## Completed Repositories"
              echo
              echo "| # | Repository | GitHub User | Project Name | Repo Created (UTC) | Quest Completed (UTC) |"
              echo "|---|------------|-------------|--------------|---------------------|------------------------|"
            } >> "${DASHBOARD_FILE}"

            rm -f "$TMP_LOG" "$TMP_MONTHS"
            exit 0
          fi

          echo "âœ… Found repositories:"
          echo "${REPOS}"

          # We'll collect detail rows as we go
          DETAILS_TABLE="$(mktemp)"

          {
            echo "| # | Repository | GitHub User | Project Name | Repo Created (UTC) | Quest Completed (UTC) |"
            echo "|---|------------|-------------|--------------|---------------------|------------------------|"
          } > "${DETAILS_TABLE}"

          INDEX=1

          while read -r repo; do
            [ -z "$repo" ] && continue

            echo "ðŸ“‚ Processing $repo ..."

            # Fetch QUEST_COMPLETION_LOG.md content (assumed at repo root)
            CONTENT_JSON=$(
              curl -sS \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${repo}/contents/QUEST_COMPLETION_LOG.md"
            )

            CONTENT_B64=$(echo "$CONTENT_JSON" | jq -r '.content // empty')

            if [ -z "$CONTENT_B64" ] || [ "$CONTENT_B64" = "null" ]; then
              echo "âš ï¸  No QUEST_COMPLETION_LOG.md found in $repo. Skipping."
              continue
            fi

            # Decode base64 to temp file
            echo "$CONTENT_B64" | base64 -d > "$TMP_LOG" 2>/dev/null || {
              echo "âš ï¸  Failed to decode QUEST_COMPLETION_LOG.md for $repo. Skipping."
              continue
            }

            # Example current log format (plain text):
            # Django Setup Quest Completion
            # MARKER: DJANGO_SETUP_QUEST_COMPLETION_TC
            #
            # Quest ID: django-setup-quest-tc
            # User: @tindyc
            # Repository: https://github.com/tindyc/django-quest-test
            # Workflow Run: ...
            # Completed at (UTC): 2025-11-21T22:11:10Z

            LAST_USER_LINE=$(grep -E "^User:" "$TMP_LOG" | tail -n 1 || true)
            LAST_TIME_LINE=$(grep -E "^Completed at \(UTC\):" "$TMP_LOG" | tail -n 1 || true)

            if [ -z "$LAST_USER_LINE" ] || [ -z "$LAST_TIME_LINE" ]; then
              echo "âš ï¸  Could not find expected 'User:' or 'Completed at (UTC):' lines in log for $repo. Skipping."
              continue
            fi

            # Strip prefixes and whitespace
            USERNAME=$(echo "$LAST_USER_LINE" | sed 's/\r$//' | sed 's/^User:[[:space:]]*@//; s/[[:space:]]*$//')
            COMPLETED_AT=$(echo "$LAST_TIME_LINE" | sed 's/\r$//' | sed 's/^Completed at (UTC):[[:space:]]*//; s/[[:space:]]*$//')

            [ -z "$USERNAME" ] && USERNAME="unknown"
            [ -z "$COMPLETED_AT" ] && COMPLETED_AT="unknown"

            REPO_NAME=$(basename "$repo")

            REPO_CREATED_AT=$(
              curl -sS \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${repo}" \
              | jq -r '.created_at // empty'
            )

            [ -z "$REPO_CREATED_AT" ] && REPO_CREATED_AT="unknown"

            # Update summary stats if COMPLETED_AT looks like an ISO timestamp
            if [[ "$COMPLETED_AT" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}T ]]; then
              MONTH_KEY=${COMPLETED_AT:0:7}
              echo "$MONTH_KEY" >> "$TMP_MONTHS"

              if [ -z "$EARLIEST" ] || [[ "$COMPLETED_AT" < "$EARLIEST" ]]; then
                EARLIEST="$COMPLETED_AT"
              fi
              if [ -z "$LATEST" ] || [[ "$COMPLETED_AT" > "$LATEST" ]]; then
                LATEST="$COMPLETED_AT"
              fi
            fi

            {
              echo "| $INDEX | [$repo](https://github.com/$repo) | [@$USERNAME](https://github.com/$USERNAME) | $REPO_NAME | $REPO_CREATED_AT | $COMPLETED_AT |"
            } >> "${DETAILS_TABLE}"

            INDEX=$((INDEX+1))
            TOTAL=$((TOTAL+1))
          done <<< "${REPOS}"

          # Summary section
          {
            echo "## Summary"
            echo
            echo "- **Total completed repositories:** ${TOTAL}"
            if [ -n "$EARLIEST" ]; then
              echo "- **First completion:** ${EARLIEST}"
            fi
            if [ -n "$LATEST" ]; then
              echo "- **Most recent completion:** ${LATEST}"
            fi
            echo
          } >> "${DASHBOARD_FILE}"

          # Monthly breakdown
          {
            echo "## Completions by Month (UTC)"
            echo
          } >> "${DASHBOARD_FILE}"

          if [ -s "$TMP_MONTHS" ]; then
            {
              echo "| Month (UTC) | Completions |"
              echo "|-------------|-------------|"
              sort "$TMP_MONTHS" | uniq -c | while read -r count month; do
                echo "| $month | $count |"
              done
              echo
            } >> "${DASHBOARD_FILE}"
          else
            {
              echo "_No valid completion timestamps to summarise by month._"
              echo
            } >> "${DASHBOARD_FILE}"
          fi

          # Detailed table
          {
            echo "## Completed Repositories"
            echo
          } >> "${DASHBOARD_FILE}"

          cat "${DETAILS_TABLE}" >> "${DASHBOARD_FILE}"

          rm -f "$TMP_LOG" "$TMP_MONTHS" "$DETAILS_TABLE"

          echo "âœ… Wrote completion dashboard to ${DASHBOARD_FILE}"

      - name: Commit dashboard to stats branch
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update Django Quest completion dashboard"
          branch: stats
