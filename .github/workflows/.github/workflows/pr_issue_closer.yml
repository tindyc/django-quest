name: Auto Close Issue on PR Merge

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  close_linked_issue:
    # Only run if the PR was merged (not just closed without merging)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    # Needs permissions to read the PR body/commits and write to issues
    permissions:
      pull-requests: read
      issues: write
      contents: read

    steps:
      - name: Close linked issue
        uses: actions/github-script@v7
        with:
          script: |
            // This script checks the PR body and commits for keywords like 'Closes #X'
            // and uses the GitHub API to close the corresponding issue.
            const prBody = context.payload.pull_request.body;
            const prCommitMessage = context.payload.pull_request.title;

            const issueNumberMatch = prBody.match(/(?:[Cc]loses|Fixes|Resolves)\s*#(\d+)/) ||
                                      prCommitMessage.match(/(?:[Cc]loses|Fixes|Resolves)\s*#(\d+)/);

            if (issueNumberMatch) {
              const issueNumber = issueNumberMatch[1];
              console.log(`Attempting to close issue #${issueNumber}`);
              
              await github.rest.issues.update({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed'
              });
              
              console.log(`Successfully closed issue #${issueNumber}.`);
            } else {
              console.log('No closing keyword found in PR title or body.');
            }