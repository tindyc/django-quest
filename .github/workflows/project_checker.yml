name: Django Setup Quest Checker

on:
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened]

env:
  # The source branch name (e.g., "issue-3-create-app").
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

jobs:
  check_django_setup:
    # Only run when the PR targets main
    if: github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------
      # 0. Show basic context and set expectations
      # ---------------------------------------
      - name: Show PR & branch info
        shell: bash
        run: |
          echo "üîç Using Branch Name: '${{ env.BRANCH_NAME }}'"
          echo "Please ensure your branch name follows the pattern 'issue-X-description' to start the Quest checks."

      # ------------------------------------------------
      # 1. Determine which Issue this branch belongs to
      # ------------------------------------------------
      - name: Detect issue number from branch name
        id: issue_info
        shell: bash
        run: |
          BRANCH="${{ env.BRANCH_NAME }}"
          if [[ "$BRANCH" =~ ^issue-([1-6])-.+ ]]; then
            ISSUE="${BASH_REMATCH[1]}"
            echo "‚úÖ Detected Issue Branch: Issue $ISSUE"
            echo "valid=true" >> "$GITHUB_OUTPUT"
            echo "issue_number=$ISSUE" >> "$GITHUB_OUTPUT"
          else
            echo "‚ö†Ô∏è Branch name does NOT match expected pattern 'issue-X-description'."
            echo "::notice::No Quest checks ran. Rename your branch (e.g., issue-3-create-app) to proceed."
            echo "valid=false" >> "$GITHUB_OUTPUT"
            echo "issue_number=0" >> "$GITHUB_OUTPUT"
          fi

      # ------------------------------------------------
      # 2. Checkout & Python setup (only for valid issue)
      # ------------------------------------------------
      - name: Stop if not an issue branch
        if: steps.issue_info.outputs.valid != 'true'
        run: echo "‚èπÔ∏è Stopping workflow early."

      - name: Checkout repository
        if: steps.issue_info.outputs.valid == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.issue_info.outputs.valid == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # ---------------------------------------
      # Issue 1 ‚Äì Install Django & requirements.txt
      # ---------------------------------------
      - name: Verify requirements.txt (Issue 1 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 1
        shell: bash
        run: |
          echo "üîé Checking for requirements.txt and Django (Issue 1)..."
          if [ ! -f requirements.txt ]; then
            echo "::error file=requirements.txt::FATAL: Missing requirements.txt. Fix: Run 'pip freeze --local > requirements.txt' (Step 5)."
            exit 1
          fi
          if ! grep -i -q "django" requirements.txt; then
            echo "::error file=requirements.txt::FATAL: Django is missing. Fix: Make sure Django is installed ('pip install Django') then re-run 'pip freeze' (Step 5)."
            exit 1
          fi
          echo "‚úÖ requirements.txt exists and contains Django."

      - name: Install dependencies
        # This step runs if Issue 1 check passed and the branch is valid (needed for all subsequent steps)
        if: success() && fromJSON(steps.issue_info.outputs.issue_number) >= 1
        shell: bash
        run: |
          echo "üì¶ Installing dependencies..."
          pip install -r requirements.txt
          echo "‚úÖ Dependencies installed."

      # ---------------------------------------
      # Issue 2 ‚Äì Project core (manage.py + settings)
      # ---------------------------------------
      - name: Verify Django project (Issue 2 Check)
        id: project_info
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 2
        shell: bash
        run: |
          echo "üîé Checking for manage.py and Django settings (Issue 2)..."
          set -e
          if [ ! -f manage.py ]; then
            echo "::error file=manage.py::FATAL: manage.py not found. Fix: Run 'django-admin startproject <project_name> .' (Step 6 - remember the dot!)."
            exit 1
          fi
          SETTINGS_FILE=$(find . -maxdepth 2 -mindepth 1 -type f -path "./*/settings.py" | head -n 1)
          if [ -z "$SETTINGS_FILE" ]; then
            echo "::error::FATAL: Could not find settings.py next to manage.py. Fix: Ensure you ran 'django-admin startproject <project_name> .' and committed the project folder."
            exit 1
          fi
          PROJECT_NAME=$(basename "$(dirname "$SETTINGS_FILE")")
          SETTINGS_PATH="$PROJECT_NAME/settings.py"
          echo "project_name=$PROJECT_NAME" >> "$GITHUB_OUTPUT"
          if [ ! -f "$SETTINGS_PATH" ]; then
            echo "::error file=$SETTINGS_PATH::FATAL: settings.py not found at $SETTINGS_PATH. Fix: Commit the project folder '$PROJECT_NAME' created by 'django-admin startproject'."
            exit 1
          fi
          echo "‚úÖ Detected project name: $PROJECT_NAME at $SETTINGS_PATH"

      # ---------------------------------------
      # Issue 3 ‚Äì App creation & registration (soft check)
      # ---------------------------------------
      - name: Verify app creation & registration (Issue 3 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 3
        shell: bash
        run: |
          echo "‚ÑπÔ∏è Skipping strict automated checks for Issue 3 (app creation & registration)."
          echo "   Make sure you have:"
          echo "   - Created a Django app with 'python manage.py startapp <app_name>'"
          echo "   - Added '<app_name>' to INSTALLED_APPS in ${{ steps.project_info.outputs.project_name }}/settings.py"

      # ---------------------------------------
      # Issue 4 ‚Äì URL routing & view
      # ---------------------------------------
      - name: Verify root URL '/' returns HTTP 200 (Issue 4 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 4
        shell: bash
        run: |
          echo "üîé Checking that GET / returns HTTP 200 (Issue 4)‚Ä¶"
          set -e
          python manage.py shell -c 'from django.test import Client; import sys; c = Client(); r = c.get("/"); sys.exit(0 if r.status_code == 200 else 1)'
          echo "‚úÖ Root URL '/' returns HTTP 200."

      # ---------------------------------------
      # Issue 5 ‚Äì Models & migrations
      # ---------------------------------------
      - name: Run makemigrations (Issue 5 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 5
        shell: bash
        run: |
          echo "üîé Running 'python manage.py makemigrations --noinput' (Issue 5)‚Ä¶"
          set -e
          python manage.py makemigrations --noinput
          echo "‚úÖ makemigrations completed successfully."

      - name: Run migrate (Issue 5 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 5
        shell: bash
        run: |
          echo "üîé Running 'python manage.py migrate --noinput' (Issue 5)‚Ä¶"
          set -e
          python manage.py migrate --noinput
          echo "‚úÖ migrate completed successfully."

      # ---------------------------------------
      # Issue 6 ‚Äì Project health (Final Check)
      # ---------------------------------------
      - name: Django system check (Issue 6 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 6
        shell: bash
        run: |
          echo "üîé Running 'python manage.py check' (Issue 6)‚Ä¶"
          set -e
          python manage.py check
          echo "‚úÖ Django system check passed."

      # ---------------------------------------
      # Final friendly summary
      # ---------------------------------------
      - name: Summary
        if: steps.issue_info.outputs.valid == 'true'
        shell: bash
        run: |
          echo "üéâ Django Quest checks finished for Issue ${{ steps.issue_info.outputs.issue_number }}."
          echo "If this job is green, you can merge your PR and move on to the next Issue."
