name: Django Setup Quest Checker

on:
  pull_request:
    branches: [ "main" ]
    types: [ opened, synchronize, reopened ]

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

jobs:
  check_django_setup:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # 0. Show PR & branch info
      # ---------------------------
      - name: Show PR & branch info
        run: |
          echo "ðŸ” Branch name: '${{ env.BRANCH_NAME }}'"
          echo "Base branch: '${{ github.base_ref }}'"

      # ---------------------------
      # 1. Detect issue number
      # ---------------------------
      - name: Detect issue number from branch name
        id: issue_info
        shell: bash
        run: |
          BRANCH="${{ env.BRANCH_NAME }}"
          if [[ "$BRANCH" =~ ^issue-([1-6])-.+ ]]; then
            ISSUE="${BASH_REMATCH[1]}"
            echo "âœ… Detected issue branch: Issue $ISSUE"
            echo "valid=true" >> "$GITHUB_OUTPUT"
            echo "issue_number=$ISSUE" >> "$GITHUB_OUTPUT"
          else
            echo "âš ï¸ Branch name does NOT match expected pattern 'issue-X-description'."
            echo "::notice::No Quest checks ran. Rename your branch (e.g. issue-1-setup) to run the Django Quest Checker."
            echo "valid=false" >> "$GITHUB_OUTPUT"
            echo "issue_number=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop if not an issue branch
        if: steps.issue_info.outputs.valid != 'true'
        run: echo "â¹ï¸ Stopping workflow â€“ not an issue-* branch."

      # ---------------------------
      # 2. Checkout & Python setup
      # ---------------------------
      - name: Checkout repository
        if: steps.issue_info.outputs.valid == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.issue_info.outputs.valid == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # ---------------------------
      # Issue 1 â€“ requirements.txt
      # ---------------------------
      - name: Verify requirements.txt (Issue 1)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 1
        shell: bash
        run: |
          echo "ðŸ”Ž Checking requirements.txt and Django (Issue 1)â€¦"

          if [ ! -f requirements.txt ]; then
            echo "::error file=requirements.txt::FATAL: requirements.txt not found. Fix: Run 'pip freeze --local > requirements.txt' after installing Django."
            exit 1
          fi

          if ! grep -i -q "django" requirements.txt; then
            echo "::error file=requirements.txt::FATAL: Django is missing from requirements.txt. Fix: 'pip install Django' then 'pip freeze --local > requirements.txt'."
            exit 1
          fi

          echo "âœ… requirements.txt exists and contains Django."

      - name: Install dependencies
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 1
        run: |
          echo "ðŸ“¦ Installing dependencies from requirements.txtâ€¦"
          pip install -r requirements.txt
          echo "âœ… Dependencies installed."

      # ---------------------------
      # Issue 2 â€“ manage.py & settings
      # ---------------------------
      - name: Verify Django project core (Issue 2)
        id: project_info
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 2
        shell: bash
        run: |
          echo "ðŸ”Ž Checking for manage.py and settings (Issue 2)â€¦"
          set -e

          if [ ! -f manage.py ]; then
            echo "::error file=manage.py::FATAL: manage.py not found. Fix: Run 'django-admin startproject <project_name> .' (note the dot at the end)."
            exit 1
          fi

          PROJECT_SETTINGS=$(grep -o "DJANGO_SETTINGS_MODULE = ['\"][^'\"]*['\"]" manage.py | sed -E "s/.*['\"](.*)['\"]/\\1/")
          PROJECT_NAME=$(echo "$PROJECT_SETTINGS" | sed 's/\..*//')
          SETTINGS_PATH=$(echo "$PROJECT_SETTINGS" | sed 's/\./\//g').py

          if [ -z "$PROJECT_NAME" ]; then
            echo "::error file=manage.py::FATAL: Could not detect DJANGO_SETTINGS_MODULE in manage.py."
            exit 1
          fi

          echo "project_name=$PROJECT_NAME" >> "$GITHUB_OUTPUT"

          if [ ! -f "$SETTINGS_PATH" ]; then
            echo "::error file=$SETTINGS_PATH::FATAL: settings.py not found at $SETTINGS_PATH. Did you commit the project folder '$PROJECT_NAME'?"
            exit 1
          fi

          echo "âœ… Detected project '$PROJECT_NAME' with settings at $SETTINGS_PATH."

      # ---------------------------
      # Issue 3 â€“ app & INSTALLED_APPS
      # ---------------------------
      - name: Verify app creation & registration (Issue 3)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 3
        shell: bash
        run: |
          PROJECT_NAME="${{ steps.project_info.outputs.project_name }}"
          SETTINGS_PATH="$PROJECT_NAME/settings.py"

          echo "ðŸ”Ž Checking for apps and INSTALLED_APPS (Issue 3)â€¦"

          APP_DIRS=$(find . -maxdepth 2 -type f -name "apps.py" -not -path "./$PROJECT_NAME/*" -printf "%h\n" | sed 's|^\./||' | sort -u)

          if [ -z "$APP_DIRS" ]; then
            echo "::error::FATAL: No Django app found. Fix: Run 'python manage.py startapp <app_name>'."
            exit 1
          fi

          MISSING=""
          for APP in $APP_DIRS; do
            APP_NAME=$(basename "$APP")
            if ! grep -q "'$APP_NAME'" "$SETTINGS_PATH"; then
              MISSING="$MISSING $APP_NAME"
            fi
          done

          if [ -n "$MISSING" ]; then
            echo "::error file=$SETTINGS_PATH::FATAL: These apps are not registered in INSTALLED_APPS:$MISSING"
            exit 1
          fi

          echo "âœ… At least one app exists and is registered in INSTALLED_APPS."

      # ---------------------------
      # Issue 4 â€“ root URL returns 200
      # ---------------------------
      - name: Verify root URL '/' returns HTTP 200 (Issue 4)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 4
        shell: bash
        run: |
          echo "ðŸ”Ž Checking that GET / returns HTTP 200 (Issue 4)â€¦"
          python manage.py shell -c "
from django.test import Client
from django.urls import resolve
import sys

try:
    match = resolve('/')
except Exception as e:
    sys.stderr.write(f'::error::ERROR: Could not resolve root URL \"/\". Fix: Check your project and app urls.py include patterns. Details: {e}\\n')
    sys.exit(1)

client = Client()
response = client.get('/')
if response.status_code != 200:
    sys.stderr.write(f'::error::ERROR: GET \"/\" returned status code {response.status_code} (expected 200). Fix: Ensure your view returns an HttpResponse.\\n')
    sys.exit(1)
"
          echo "âœ… Root URL '/' returns HTTP 200."

      # ---------------------------
      # Issue 5 â€“ makemigrations & migrate
      # ---------------------------
      - name: Run makemigrations (Issue 5)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 5
        run: |
          echo "ðŸ”Ž Running 'python manage.py makemigrations --noinput' (Issue 5)â€¦"
          python manage.py makemigrations --noinput
          echo "âœ… makemigrations completed successfully."

      - name: Run migrate (Issue 5)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 5
        run: |
          echo "ðŸ”Ž Running 'python manage.py migrate --noinput' (Issue 5)â€¦"
          python manage.py migrate --noinput
          echo "âœ… migrate completed successfully."

      # ---------------------------
      # Issue 6 â€“ system check
      # ---------------------------
      - name: Django system check (Issue 6)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 6
        run: |
          echo "ðŸ”Ž Running 'python manage.py check' (Issue 6)â€¦"
          python manage.py check
          echo "âœ… Django system check passed."

      # ---------------------------
      # Friendly summary
      # ---------------------------
      - name: Summary
        if: steps.issue_info.outputs.valid == 'true'
        run: |
          echo "ðŸŽ‰ Django Quest checks finished for Issue ${{ steps.issue_info.outputs.issue_number }}."
          echo "If this job is green, you can merge your PR and move on to the next Issue."
