name: Django Setup Quest Checker

on:
  pull_request:
    branches: [ "main" ]
    types: [ opened, synchronize, reopened ]

env:
  # The source branch name (e.g., "issue-3-create-app").
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

jobs:
  check_django_setup:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------
      # 0. Show basic context and set expectations
      # ---------------------------------------
      - name: Show PR & branch info
        run: |
          echo "ðŸ” Using Branch Name: '${{ env.BRANCH_NAME }}'"
          echo "Please ensure your branch name follows the pattern 'issue-X-description' to start the Quest checks."

      # ------------------------------------------------
      # 1. Determine which Issue this branch belongs to
      # ------------------------------------------------
      - name: Detect issue number from branch name
        id: issue_info
        shell: bash
        run: |
          BRANCH="${{ env.BRANCH_NAME }}"
          # Use regex to validate branch name structure and extract the issue number
          if [[ "$BRANCH" =~ ^issue-([1-6])-.+ ]]; then
            ISSUE="${BASH_REMATCH[1]}"
            echo "âœ… Detected Issue Branch: Issue $ISSUE"
            echo "valid=true" >> "$GITHUB_OUTPUT"
            echo "issue_number=$ISSUE" >> "$GITHUB_OUTPUT"
          else
            echo "âš ï¸ Branch name does NOT match expected pattern 'issue-X-description'."
            echo "::notice::No Quest checks ran. Rename your branch (e.g., issue-3-create-app) to proceed."
            echo "valid=false" >> "$GITHUB_OUTPUT"
            echo "issue_number=0" >> "$GITHUB_OUTPUT"
          fi

      # ------------------------------------------------
      # 2. Checkout & Python setup (only for valid issue)
      # ------------------------------------------------
      - name: Stop if not an issue branch
        if: steps.issue_info.outputs.valid != 'true'
        run: echo "â¹ï¸ Stopping workflow early."

      - name: Checkout repository
        if: steps.issue_info.outputs.valid == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.issue_info.outputs.valid == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # ---------------------------------------
      # Issue 1 â€“ Install Django & requirements.txt
      # ---------------------------------------
      - name: Verify requirements.txt (Issue 1 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 1
        shell: bash
        run: |
          echo "ðŸ”Ž Checking for requirements.txt and Django (Issue 1)..."

          if [ ! -f requirements.txt ]; then
            echo "::error file=requirements.txt::FATAL: Missing requirements.txt. Fix: Run 'pip freeze --local > requirements.txt' (Step 5)."
            exit 1
          fi

          if ! grep -i -q "django" requirements.txt; then
            echo "::error file=requirements.txt::FATAL: Django is missing. Fix: Make sure Django is installed ('pip install Django') then re-run 'pip freeze' (Step 5)."
            exit 1
          fi
          echo "âœ… requirements.txt exists and contains Django."

      - name: Install dependencies
        # This step runs if Issue 1 check passed and the branch is valid (needed for all subsequent steps)
        if: success() && fromJSON(steps.issue_info.outputs.issue_number) >= 1
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          pip install -r requirements.txt
          echo "âœ… Dependencies installed."

      # ---------------------------------------
      # Issue 2 â€“ Project core (manage.py + settings)
      # ---------------------------------------
      - name: Verify Django project (Issue 2 Check)
        id: project_info
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 2
        shell: bash
        run: |
          echo "ðŸ”Ž Checking for manage.py and Django settings (Issue 2)..."
          set -e

          if [ ! -f manage.py ]; then
            echo "::error file=manage.py::FATAL: manage.py not found. Fix: Run 'django-admin startproject <project_name> .' (Step 6 - remember the dot!)."
            exit 1
          fi

          # FIX: Simplify settings detection logic to avoid complex regex issues
          PROJECT_SETTINGS=$(grep 'DJANGO_SETTINGS_MODULE' manage.py | grep -o "\'.*\'" | tr -d "'")
          
          if [ -z "$PROJECT_SETTINGS" ]; then
             echo "::error file=manage.py::FATAL: Could not extract DJANGO_SETTINGS_MODULE. Fix: Ensure manage.py is standard."
             exit 1
          fi
          
          PROJECT_NAME=$(echo "$PROJECT_SETTINGS" | sed 's/\..*//')
          SETTINGS_PATH=$(echo "$PROJECT_SETTINGS" | sed 's/\./\//g').py

          echo "project_name=$PROJECT_NAME" >> "$GITHUB_OUTPUT"

          if [ ! -f "$SETTINGS_PATH" ]; then
            echo "::error file=$SETTINGS_PATH::FATAL: settings.py not found at $SETTINGS_PATH. Fix: Commit the project folder '$PROJECT_NAME' created by 'django-admin startproject'."
            exit 1
          fi

          echo "âœ… Detected project name: $PROJECT_NAME at $SETTINGS_PATH"

      # ---------------------------------------
      # Issue 3 â€“ App creation & registration
      # ---------------------------------------
      - name: Verify app creation & registration (Issue 3 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 3
        shell: bash
        run: |
          PROJECT_NAME="${{ steps.project_info.outputs.project_name }}"
          SETTINGS_PATH="$PROJECT_NAME/settings.py" 
          echo "ðŸ”Ž Checking for a custom app and its registration (Issue 3)..."
          set -e

          # Find directories with apps.py (excluding the project settings folder itself)
          APP_DIRS=$(find . -maxdepth 2 -type f -name "apps.py" -not -path "./$PROJECT_NAME/*" -printf "%h\n" | sed 's|^\./||' | sort -u)

          if [ -z "$APP_DIRS" ]; then
            echo "::error::FATAL: No custom Django app (apps.py) found. Fix: Run 'python manage.py startapp <app_name>' (Step 8)."
            exit 1
          fi

          MISSING_REG=""
          for APP in $APP_DIRS; do
            APP_NAME=$(basename "$APP")
            # Check if the app name is in INSTALLED_APPS (Step 11)
            if ! grep -q "'$APP_NAME'" "$SETTINGS_PATH"; then
              MISSING_REG="$MISSING_REG $APP_NAME"
            fi
          done

          if [ -n "$MISSING_REG" ]; then
            echo "::error file=$SETTINGS_PATH::FATAL: The following apps are not registered in INSTALLED_APPS: $MISSING_REG. Fix: Add '<app_name>' to INSTALLED_APPS in '$SETTINGS_PATH' (Step 11)."
            exit 1
          fi

          echo "âœ… At least one app exists and is registered in INSTALLED_APPS."

      # ---------------------------------------
      # Issue 4 â€“ URL routing & view (Single-line shell command fix)
      # ---------------------------------------
      - name: Verify root URL '/' returns HTTP 200 (Issue 4 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 4
        shell: bash
        run: |
          echo "ðŸ”Ž Checking that GET / returns HTTP 200 (Issue 4)â€¦"
          set -e # Stop bash script on error
          
          # Consolidated Python script into a single shell command to avoid multi-line YAML parsing errors.
          python manage.py shell -c "from django.test import Client; from django.urls import resolve; import sys; try: resolve('/'); except Exception as e: sys.stderr.write(f'::error::ERROR: Could not resolve root URL \"/\". Fix: Check urls.py includes (Step 10). Details: {e}\n'); sys.exit(1); client = Client(); response = client.get('/'); if response.status_code != 200: sys.stderr.write(f'::error::ERROR: GET \"/\" returned {response.status_code} (expected 200). Fix: Ensure your view returns an HttpResponse (Step 9).\n'); sys.exit(1);"
          
          echo "âœ… Root URL '/' returns HTTP 200." 

      # ---------------------------------------
      # Issue 5 â€“ Models & migrations
      # ---------------------------------------
      - name: Run makemigrations (Issue 5 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 5
        run: |
          echo "ðŸ”Ž Running 'python manage.py makemigrations --noinput' (Issue 5)â€¦"
          set -e
          python manage.py makemigrations --noinput
          echo "âœ… makemigrations completed successfully."

      - name: Run migrate (Issue 5 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 5
        run: |
          echo "ðŸ”Ž Running 'python manage.py migrate --noinput' (Issue 5)â€¦"
          set -e
          python manage.py migrate --noinput
          echo "âœ… migrate completed successfully."

      # ---------------------------------------
      # Issue 6 â€“ Project health (Final Check)
      # ---------------------------------------
      - name: Django system check (Issue 6 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 6
        run: |
          echo "ðŸ”Ž Running 'python manage.py check' (Issue 6)â€¦"
          set -e
          python manage.py check
          echo "âœ… Django system check passed."

      # ---------------------------------------
      # Final friendly summary
      # ---------------------------------------
      - name: Summary
        if: steps.issue_info.outputs.valid == 'true'
        run: |
          echo "ðŸŽ‰ Django Quest checks finished for Issue ${{ steps.issue_info.outputs.issue_number }}."
          echo "If this job is green, you can merge your PR and move on to the next Issue."