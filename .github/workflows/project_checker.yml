name: Django Setup Quest Checker

on:
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened]

env:
  # The source branch name (e.g., "issue-3-create-app").
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

jobs:
  check_django_setup:
    # Only run when the PR targets main
    if: github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------
      # 0. Show basic context and set expectations
      # ---------------------------------------
      - name: Show PR & branch info
        shell: bash
        run: |
          echo "üîç Using Branch Name: '${{ env.BRANCH_NAME }}'"
          echo "Please ensure your branch name follows the pattern 'issue-X-description' to start the Quest checks."

      # ------------------------------------------------
      # 1. Determine which Issue this branch belongs to
      # ------------------------------------------------
      - name: Detect issue number from branch name
        id: issue_info
        shell: bash
        run: |
          BRANCH="${{ env.BRANCH_NAME }}"
          # Support issue-1-... up to issue-10-...
          if [[ "$BRANCH" =~ ^issue-([1-9]|10)-.+ ]]; then
            ISSUE="${BASH_REMATCH[1]}"
            echo "‚úÖ Detected Issue Branch: Issue $ISSUE"
            echo "valid=true" >> "$GITHUB_OUTPUT"
            echo "issue_number=$ISSUE" >> "$GITHUB_OUTPUT"
          else
            echo "‚ö†Ô∏è Branch name does NOT match expected pattern 'issue-X-description'."
            echo "::notice::No Quest checks ran. Rename your branch (e.g., issue-3-create-app) to proceed."
            echo "valid=false" >> "$GITHUB_OUTPUT"
            echo "issue_number=0" >> "$GITHUB_OUTPUT"
          fi

      # ------------------------------------------------
      # 2. Checkout & Python setup (only for valid issue)
      # ------------------------------------------------
      - name: Stop if not an issue branch
        if: steps.issue_info.outputs.valid != 'true'
        run: echo "‚èπÔ∏è Stopping workflow early."

      - name: Checkout repository
        if: steps.issue_info.outputs.valid == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.issue_info.outputs.valid == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # ---------------------------------------
      # Issue 1 ‚Äì Install Django & requirements.txt
      # ---------------------------------------
      - name: Verify requirements.txt (Issue 1 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 1
        shell: bash
        run: |
          echo "üîé Checking for requirements.txt and Django (Issue 1)..."
          if [ ! -f requirements.txt ]; then
            echo "::error file=requirements.txt::FATAL: Missing requirements.txt. Fix: Run 'pip freeze --local > requirements.txt' (Step 5)."
            exit 1
          fi
          if ! grep -i -q "django" requirements.txt; then
            echo "::error file=requirements.txt::FATAL: Django is missing. Fix: Make sure Django is installed ('pip install Django') then re-run 'pip freeze' (Step 5)."
            exit 1
          fi
          echo "‚úÖ requirements.txt exists and contains Django."

      - name: Install dependencies
        # This step runs if Issue 1 check passed and the branch is valid (needed for all subsequent steps)
        if: success() && fromJSON(steps.issue_info.outputs.issue_number) >= 1
        shell: bash
        run: |
          echo "üì¶ Installing dependencies..."
          pip install -r requirements.txt
          echo "‚úÖ Dependencies installed."

      # ---------------------------------------
      # Issue 2 ‚Äì Project core (manage.py + settings)
      # ---------------------------------------
      - name: Verify Django project (Issue 2 Check)
        id: project_info
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 2
        shell: bash
        run: |
          echo "üîé Checking for manage.py and Django settings (Issue 2)..."
          set -e
          if [ ! -f manage.py ]; then
            echo "::error file=manage.py::FATAL: manage.py not found. Fix: Run 'django-admin startproject <project_name> .' (Step 6 - remember the dot!)."
            exit 1
          fi
          SETTINGS_FILE=$(find . -maxdepth 2 -mindepth 1 -type f -path "./*/settings.py" | head -n 1)
          if [ -z "$SETTINGS_FILE" ]; then
            echo "::error::FATAL: Could not find settings.py next to manage.py. Fix: Ensure you ran 'django-admin startproject <project_name> .' and committed the project folder."
            exit 1
          fi
          PROJECT_NAME=$(basename "$(dirname "$SETTINGS_FILE")")
          SETTINGS_PATH="$PROJECT_NAME/settings.py"
          echo "project_name=$PROJECT_NAME" >> "$GITHUB_OUTPUT"
          if [ ! -f "$SETTINGS_PATH" ]; then
            echo "::error file=$SETTINGS_PATH::FATAL: settings.py not found at $SETTINGS_PATH. Fix: Commit the project folder '$PROJECT_NAME' created by 'django-admin startproject'."
            exit 1
          fi
          echo "‚úÖ Detected project name: $PROJECT_NAME at $SETTINGS_PATH"

      # ---------------------------------------
      # Issue 3 ‚Äì App creation & registration 
      # ---------------------------------------
      - name: Verify app creation & registration (Issue 3 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 3
        shell: bash
        run: |
          echo "üîé Checking Django app creation & registration (Issue 3)‚Ä¶"
          set -e

          PROJECT_NAME="${{ steps.project_info.outputs.project_name }}"
          SETTINGS_PATH="$PROJECT_NAME/settings.py"

          if [ -z "$PROJECT_NAME" ]; then
            echo "::error::FATAL: PROJECT_NAME from Issue 2 was not detected. Make sure Issue 2 passed successfully."
            exit 1
          fi

          if [ ! -f "$SETTINGS_PATH" ]; then
            echo "::error file=$SETTINGS_PATH::FATAL: settings.py not found while running Issue 3 check. Did you complete Issue 2 and commit your Django project?"
            exit 1
          fi

          echo "‚ÑπÔ∏è Using settings file at: $SETTINGS_PATH"

          # Find app modules that contain apps.py (i.e., real Django apps), excluding the project package
          APP_MODULES=$(find . -maxdepth 2 -mindepth 1 -type f -name "apps.py" | grep -v "./$PROJECT_NAME/" || true)

          if [ -z "$APP_MODULES" ]; then
            echo "::error::FATAL: No Django app with an apps.py file was found."
            echo "       Fix: From your project root, run 'python manage.py startapp <app_name>' and commit the new app."
            exit 1
          fi

          # Take the first discovered app as the candidate
          FIRST_APP_APPS_PY=$(echo "$APP_MODULES" | head -n 1)
          APP_DIR=$(dirname "$FIRST_APP_APPS_PY")
          APP_NAME=$(basename "$APP_DIR")

          echo "‚ÑπÔ∏è Detected app candidate: '$APP_NAME' (from $FIRST_APP_APPS_PY)"

          # Check if APP_NAME or its AppConfig is registered in INSTALLED_APPS
          if ! grep -Eq "['\"]$APP_NAME['\"]|['\"]$APP_NAME\.apps\.[A-Za-z0-9_]+Config['\"]" "$SETTINGS_PATH"; then
            echo "::error file=$SETTINGS_PATH::FATAL: Could not find '$APP_NAME' registered in INSTALLED_APPS."
            echo "       Fix: Add '$APP_NAME' (or its AppConfig, e.g. '$APP_NAME.apps.YourAppConfig') to INSTALLED_APPS in $SETTINGS_PATH."
            exit 1
          fi

          echo "‚úÖ App '$APP_NAME' appears to exist and is registered in INSTALLED_APPS."
          
      # ---------------------------------------
      # Issue 4 ‚Äì URL routing & view
      # ---------------------------------------
      - name: Verify root URL '/' returns HTTP 200 (Issue 4 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 4
        shell: bash
        run: |
          echo "üîé Checking that GET / returns HTTP 200 (Issue 4)‚Ä¶"
          set -e
          python manage.py shell -c 'from django.test import Client; from django.conf import settings; settings.ALLOWED_HOSTS = list(getattr(settings, "ALLOWED_HOSTS", [])) + ["testserver"]; c = Client(); r = c.get("/"); import sys; sys.exit(0 if r.status_code == 200 else 1)'
          echo "‚úÖ Root URL '/' returns HTTP 200."

      # ---------------------------------------
      # Issue 5 ‚Äì Models & migrations
      # ---------------------------------------
      - name: Run makemigrations (Issue 5 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 5
        shell: bash
        run: |
          echo "üîé Running 'python manage.py makemigrations --noinput' (Issue 5)‚Ä¶"
          set -e
          python manage.py makemigrations --noinput
          echo "‚úÖ makemigrations completed successfully."

      - name: Run migrate (Issue 5 Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 5
        shell: bash
        run: |
          echo "üîé Running 'python manage.py migrate --noinput' (Issue 5)‚Ä¶"
          set -e
          python manage.py migrate --noinput
          echo "‚úÖ migrate completed successfully."

      # ---------------------------------------
      # Issue 6 ‚Äì Project health (System check)
      # ---------------------------------------
      - name: Django system check (Issue 6+ Check)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 6
        shell: bash
        run: |
          echo "üîé Running 'python manage.py check' (Issue 6 and later)‚Ä¶"
          set -e
          python manage.py check
          echo "‚úÖ Django system check passed."

      # ---------------------------------------
      # Issue 7‚Äì9 ‚Äì Manual feature checks (generic)
      # ---------------------------------------
      - name: Manual feature reminders (Issues 7‚Äì9)
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 7 &&
          fromJSON(steps.issue_info.outputs.issue_number) <= 9
        shell: bash
        run: |
          echo "‚ÑπÔ∏è Automated Django health checks passed."
          echo "For Issues 7‚Äì9, also manually verify in your browser that:"
          echo "  - Your main page (or the page you built in this issue) loads without errors."
          echo "  - It displays data from your own model/app (for example: a list, table, or cards of objects)."
          echo "  - Any links or buttons you added to view more details actually work and load a page."
          echo "  - Detail pages (if you created them) show the correct information for a single object."
          echo ""
          echo "These behaviour checks depend on your own model and app design, so they are not fully"
          echo "automated here ‚Äî but they are required to complete the Quest steps."

      # ---------------------------------------
      # Issue 10 ‚Äì Quest wrap-up (no extra checks)
      # ---------------------------------------
      - name: Issue 10 ‚Äì Quest wrap-up note
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) == 10
        shell: bash
        run: |
          echo "üéì This is Issue 10 ‚Äì Quest Complete & Reflection."
          echo "There are no extra automated checks for this issue."
          echo "Use this PR to review your work, tidy anything up, then merge to finish the Quest!"

      # ---------------------------------------
      # Final friendly summary
      # ---------------------------------------
      - name: Summary
        if: steps.issue_info.outputs.valid == 'true'
        shell: bash
        run: |
          echo "üéâ Django Quest checks finished for Issue ${{ steps.issue_info.outputs.issue_number }}."
          echo "If this job is green, you can merge your PR and move on to the next Issue."
