name: Django Setup Quest Checker

on:
  pull_request:
    branches: [ "main" ]
    types: [ opened, synchronize, reopened ]

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

jobs:
  check_django_setup:
    if: github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Show PR & branch info
        run: |
          echo "ðŸ” Using Branch Name: '${{ env.BRANCH_NAME }}'"

      - name: Detect issue number from branch name
        id: issue_info
        shell: bash
        run: |
          BRANCH="${{ env.BRANCH_NAME }}"
          if [[ "$BRANCH" =~ ^issue-([1-6])-.+ ]]; then
            ISSUE="${BASH_REMATCH[1]}"
            echo "valid=true" >> "$GITHUB_OUTPUT"
            echo "issue_number=$ISSUE" >> "$GITHUB_OUTPUT"
          else
            echo "valid=false" >> "$GITHUB_OUTPUT"
            echo "issue_number=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop if not an issue branch
        if: steps.issue_info.outputs.valid != 'true'
        run: echo "â¹ï¸ Stopping workflow early."

      - name: Checkout repository
        if: steps.issue_info.outputs.valid == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.issue_info.outputs.valid == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Verify requirements.txt
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 1
        run: |
          if [ ! -f requirements.txt ]; then exit 1; fi
          grep -qi "django" requirements.txt || exit 1

      - name: Install dependencies
        if: success()
        run: pip install -r requirements.txt

      - name: Verify Django project (Issue 2)
        id: project_info
        if: |
          steps.issue_info.outputs.valid == 'true' &&
          fromJSON(steps.issue_info.outputs.issue_number) >= 2
        run: |
          if [ ! -f manage.py ]; then exit 1; fi
          PROJECT_SETTINGS=$(grep 'os.environ.setdefault' manage.py | grep -o "['\"].*['\"]" | tr -d "'"" )
          PROJECT_NAME=$(echo "$PROJECT_SETTINGS" | sed 's/\..*//')
          SETTINGS_PATH=$(echo "$PROJECT_SETTINGS" | sed 's/\./\//g').py
          echo "project_name=$PROJECT_NAME" >> "$GITHUB_OUTPUT"
          if [ ! -f "$SETTINGS_PATH" ]; then exit 1; fi

      - name: Summary
        if: steps.issue_info.outputs.valid == 'true'
        run: echo "ðŸŽ‰ Django Quest checks complete!"
