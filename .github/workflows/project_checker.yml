name: Django Quest Issue Sequencer

on:
  issues:
    types: [closed]

jobs:
  open_next_issue:
    runs-on: ubuntu-latest
    # Define outputs to be used by the 'finish_quest' job
    outputs:
      finish_quest: ${{ steps.next.outputs.finish_quest }}
      
    steps:
      - name: Show closed issue info
        run: |
          echo "Closed issue: #${{ github.event.issue.number }}"

      # Decide what the next issue should be, based on the label
      - name: Determine next issue
        id: next
        shell: bash
        run: |
          LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
          
          NEXT_TITLE=""
          NEXT_FILE=""
          NEXT_LABEL=""
          FINISH_QUEST="false"

          if echo "$LABELS" | grep -q "issue-1"; then
            NEXT_TITLE="Issue 2 â€“ Project Core: Create Project Structure"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-2-project-core.md"
            NEXT_LABEL="issue-2"
          elif echo "$LABELS" | grep -q "issue-2"; then
            NEXT_TITLE="Issue 3 â€“ App Creation & Registration"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-3-app-and-registration.md"
            NEXT_LABEL="issue-3"
          elif echo "$LABELS" | grep -q "issue-3"; then
            NEXT_TITLE="Issue 4 â€“ URL Routing & View Test"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-4-url-and-view.md"
            NEXT_LABEL="issue-4"
          elif echo "$LABELS" | grep -q "issue-4"; then
            NEXT_TITLE="Issue 5 â€“ Database: Models & Migrations"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-5-models-and-templates.md"
            NEXT_LABEL="issue-5"
          elif echo "$LABELS" | grep -q "issue-5"; then
            NEXT_TITLE="Issue 6 â€“ User Management: Create Superuser"
            NEXT_FILE=".github/ISSUE_TEMPLATE/issue-6-superuser.md"
            NEXT_LABEL="issue-6"
          elif echo "$LABELS" | grep -q "issue-6"; then
            FINISH_QUEST="true" # Flag the final completion
          fi

          echo "next_title=$NEXT_OUTPUT" >> "$GITHUB_OUTPUT"
          echo "next_file=$NEXT_FILE" >> "$GITHUB_OUTPUT"
          echo "next_label=$NEXT_LABEL" >> "$GITHUB_OUTPUT"
          echo "finish_quest=$FINISH_QUEST" >> "$GITHUB_OUTPUT"

      - name: Stop if no action is needed
        if: steps.next.outputs.next_title == '' && steps.next.outputs.finish_quest == 'false'
        run: echo "âœ… No next issue to create."

      - name: Checkout repository for Issue Creation
        if: steps.next.outputs.next_title != ''
        uses: actions/checkout@v4

      - name: Create next issue
        if: steps.next.outputs.next_title != ''
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: ${{ steps.next.outputs.next_title }}
          content-filepath: ${{ steps.next.outputs.next_file }}
          labels: ${{ steps.next.outputs.next_label }}
          
  # --- NEW JOB: CONGRATULATE STUDENT AND UPDATE README ---
  finish_quest:
    runs-on: ubuntu-latest
    needs: open_next_issue
    if: needs.open_next_issue.outputs.finish_quest == 'true' 

    steps:
      - name: Checkout repository for README update
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }} 

      - name: Add Congratulations Message to README.md
        shell: bash
        run: |
          CONGRATS_MESSAGE=$(cat <<-EOF
          
          
          ## ðŸŽ‰ QUEST COMPLETE: CONGRATULATIONS! ðŸŽ‰
          
          **You have successfully completed the entire Django Quest Workshop!** You installed Django, configured the project structure, created your first app, set up URL routing, defined models, ran migrations, and prepared the project for administration. 
          
          This project is now a solid foundation for building your complete application.
          
          ---
          
          ### Next Steps
          
          1. **Run Locally:** Run \`python manage.py runserver\`
          2. **Login:** Visit /admin/ and log in with the superuser you created (Step 20) to manage your data!
          
          EOF
          )
          
          echo "$CONGRATS_MESSAGE" >> README.md

      - name: Commit and Push README changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'docs: Celebrate completion of Django Quest workshop!'
          branch: main